SELECT 
	TBT_GRADE_ITEM_CARRINHO.CodCarrinho AS CodCarrinho,
	TBT_GRADE_ITEM_CARRINHO.CodItemCarrinho AS CodItemCarrinho,
	TBT_GRADE_ITEM_CARRINHO.CodGradeItemCarrinho AS CodGradeItemCarrinho,
	TBT_GRADE_ITEM_CARRINHO.Qtd AS Qtd,
	TBT_GRADE_ITEM_CARRINHO.CodDerivacao AS CodDerivacao,
	IFNULL(TBT_GRADE.TamanhoCaixa,1) As TamanhoCaixa,
	IPE.Quantidade AS Estoque
FROM TBT_GRADE_ITEM_CARRINHO
INNER JOIN TBT_ITEM_CARRINHO ON TBT_GRADE_ITEM_CARRINHO.CodCarrinho = TBT_ITEM_CARRINHO.CodCarrinho AND TBT_GRADE_ITEM_CARRINHO.CodItemCarrinho = TBT_ITEM_CARRINHO.CodItemCarrinho
LEFT JOIN TBT_GRADE ON TBT_GRADE.CodGrade = TBT_ITEM_CARRINHO.CodGrade
LEFT JOIN TBT_ITEM_PRONTA_ENTREGA IPE ON IPE.CodProduto = TBT_ITEM_CARRINHO.CodProduto AND TBT_ITEM_CARRINHO.DataEntrega = IPE.DataDisponibilidade
WHERE TBT_GRADE_ITEM_CARRINHO.CodCarrinho = '@CodCarrinho'
AND TBT_GRADE_ITEM_CARRINHO.CodItemCarrinho = '@CodItemCarrinho'
AND (
	(IPE.Quantidade IS NULL OR
	(IFNULL(TBT_GRADE.TamanhoCaixa,1) = 1 AND IPE.CodGrade = TBT_GRADE_ITEM_CARRINHO.CodDerivacao)
	OR (IFNULL(TBT_GRADE.TamanhoCaixa,1) > 1 AND IPE.CodGrade = TBT_ITEM_CARRINHO.CodGrade))
);